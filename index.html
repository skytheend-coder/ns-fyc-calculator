// --- index.html æ ¸å¿ƒè¨ˆç®—é‚è¼¯ä¿®æ­£ ---

const calculateRowResult = (row) => {
    let input = (row.code || '').trim().toUpperCase();
    if (!input) return { valid: false, availableTerms: [] };
    
    // ðŸ’¡ ä¿®æ­£ 1ï¼šæ›´å¯¬é¬†ä¸”ç²¾æº–çš„ä»£ç¢¼æå–
    // å…ˆå˜—è©¦æå–æœ«å°¾è‹±æ•¸ï¼Œè‹¥å¤±æ•—å‰‡ç¶­æŒåŽŸæ¨£ï¼Œç¢ºä¿æ‰‹æ‰“ STCB ä¹Ÿèƒ½é€š
    const cleanCode = input.match(/[A-Z0-9]+$/)?.[0] || input;
    
    // ðŸ’¡ ä¿®æ­£ 2ï¼šå„ªå…ˆåŒ¹é…å®Œå…¨ä¸€è‡´çš„ code æˆ– alias
    let matched = db.filter(r => r.code === cleanCode || (r.alias && r.alias.includes(cleanCode)));
    
    // å¦‚æžœé‚„æ˜¯æ‰¾ä¸åˆ°ï¼Œæ‰è©¦è‘—æ‰¾ã€ŒåŒ…å«ã€è©²ä»£ç¢¼çš„é …ç›® (ä¾‹å¦‚è¼¸å…¥ STC æ‰¾ STCB)
    if (matched.length === 0) {
        matched = db.filter(r => r.code.includes(cleanCode));
    }

    const availableTerms = [...new Set(matched.map(m => String(m.term)))].sort((a, b) => parseInt(a) - parseInt(b));
    
    // ðŸ’¡ ä¿®æ­£ 3ï¼šå¹´æœŸåŒ¹é…é‚è¼¯
    const rate = matched.find(r => String(r.term) === String(row.term) && parseInt(age) >= r.minAge && parseInt(age) <= r.maxAge);

    if (!rate) return { valid: false, availableTerms, matchedCode: matched[0]?.code || cleanCode };

    const p = parseFloat(row.premium) || 0;
    const fyc = p * (rate.fycRate / 100);
    const marketing = p * (rate.marketingRate / 100);
    const bonus = fyc * 0.1;
    
    const weight = (function(cat, t){
        const tv = parseInt(t);
        if (['PA', 'HI', 'LTC', 'CA', 'TOPIC'].includes(cat)) return (tv === 2) ? 0.6 : 3.0;
        if (['LIFE', 'FIXED', 'INVEST'].includes(cat)) {
            if (tv === 1) return 0.05; if (tv === 2) return 0.2; if (tv === 3) return 0.3;
            if (tv === 6) return 1.0; if (tv >= 10 && tv < 20) return 2.0; if (tv >= 20) return 3.0;
        }
        return 1.0;
    })(rate.cat, rate.term);

    return { 
        valid: true, fyc, marketing, bonus, 
        total: fyc + marketing + bonus, 
        weightedValue: p * weight 
    };
};
